
<style>
    /* RESET CODE - THIS GOES IN EVERY TIME - GETS RID OF ANY STYLINGS THE MIRROR MIGHT BE IMPOSING*/
    div#du_body_psbt{font-size:16px;margin:0 auto;padding:0;border:0;line-height:1em}
    div#du_body_psbt div,
    div#du_body_psbt h1,
    div#du_body_psbt h2,
    div#du_body_psbt h4,
    div#du_body_psbt p,
    div#du_body_psbt span,
    div#du_body_psbt ul,
    div#du_body_psbt li,
    div#du_body_psbt img,
    div#du_body_psbt button,
    div#du_body_psbt input,
    div#du_body_psbt select
    {margin:0;padding:0;border:0;font-size:100%;font:inherit;vertical-align:baseline;line-height:normal;box-sizing:content-box}
    div#du_body_psbt ul,
    div#du_body_psbt li
    {list-style:none;}
    div#du_body_psbt img{display:block}
    div#du_body_psbt .du_img_hd,
    div#du_body_psbt h2::before,
    div#du_body_psbt h2::after,
    div#du_body_psbt h3::before,
    div#du_body_psbt h3::after
    {display:none}

    /* CLEARFIX - THIS GOES IN EVERY TIME */
    div#du_body_psbt div#du_header:after,
    div#du_body_psbt:after
    {content: ".";display: block;clear: both;visibility: hidden;line-height: 0;height: 0;}
    div#du_body_psbt div#du_header,
    div#du_body_psbt    {display: inline-block;}
    html[xmlns] div#du_body_psbt div#du_header,
    html[xmlns] div#du_body_psbt    {display: block;}
    * html div#du_body_psbt div#du_header,
    * html div#du_body_psbt    {height: 1%;}
    
    /* WIDGET CSS - THIS IS ALL UP FOR GRABS ALTHOUGH SOME OF IT SHOULD STAY THE SAME (SPINNER) */
    div#du_body_psbt{
        color:#000;
        position: relative;
        width: 100%;
        max-width: 614px; /* Keep this max-width */
        text-align: left;
        margin:0 auto;
        font-family: 'PT Sans', Helvetica, Arial, sans-serif;
        background: rgb(173,216,230);
        background-color: rgba(173,216,230,0.6);
        border: 3px solid #000;
    }
    div#du_body_psbt #du_wait_psbt{
        background-color:#444;
        background: none no-repeat scroll center center rgba(0, 0, 0, 0.5);
        display: block;
        height: 100%;
        width: 100%;
        position: absolute;
        z-index: 3;
        left: 0;
        top: 0;
        //background-image: url();
    }
    /* SPINNING WHEEL GIF */
    div#du_body_psbt #du_wait_psbt span{
        background: none no-repeat scroll center center transparent;
        background-color: rgba(0, 0, 0, 0.4);
        background-image: url(http://trinitymirrordataunit.com.s3.amazonaws.com/img/base/spinning-loader-black-bg.gif);
        -webkit-border-radius: 20px;
        -moz-border-radius: 20px;
        border-radius: 20px;
        display: block;
        height: 100px;
        margin: 0 auto;
        position: relative;
        top: 21%;
        width: 100px;
    }
    div#du_body_psbt #du_wait_psbt.du_hide{
        display: none;
    }
    div#du_body_psbt #du_js_warning{
        text-align:center;
        background-color: #000;
        padding: 15px 0;
        color:red;
    }
    div#du_body_psbt div#du_header {
        font-size: 20px;
        display: block;
    }
    div#du_body_psbt .du_header_img{
        display: block;
        margin-bottom: 20px;
        width: 100%;
    }

    /* START OF MY CSS */
    div#du_body_psbt h2{
        font-family: 'PT Sans Narrow', Helvetica, Arial, sans-serif;
        font-size: 30px;
        font-weight: bold;
        text-align: center
    }
    div#du_body_psbt div#du_widget_res{
        margin: 0 auto;
        width:100%;
        display: none
    }
    div#du_body_psbt div#du_scale{
        text-align: center;
        width:100%;
    }
    div#du_body_psbt div#du_widget{
        min-height:500px;
        display: none
    }


    div#du_body_psbt #du_chart-container, 
    div#du_body_psbt #du_widget, 
    div#du_body_psbt #du_response {
        width: 95%;
        margin: 0 auto;
        max-width: 600px;
    }

    div#du_body_psbt #du_response { 
        padding-top: 20px;
    }

    div#du_body_psbt p {
        margin:0 20px 10px;
        text-align: center;
    }
    div#du_body_psbt #du_source {
        margin: 0px
    }
    div#du_body_psbt h1, 
    div#du_body_psbt h3 {
        font-family: 'PT Sans Narrow', Helvetica, Arial, sans-serif;
        font-weight: bold;
        text-align: center;
    }
    div#du_body_psbt h1 {
        margin-top: 20px;
        font-size: 30px;
        padding-bottom: 15px;
    }
    div#du_body_psbt h3 {
        margin-left: 10px;
        margin-right: 10px;
        font-size: 22px;
    }

    div#du_body_psbt text, 
    div#du_body_psbt p, 
    div#du_body_psbt li, 
    div#du_body_psbt button, 
    div#du_body_psbt input { 
        font-family: "PT Sans", serif;
    }
    div#du_body_psbt text {
        font-weight: bold;
    }

    div#du_body_psbt input { 
        border: 1px solid black;
        font-size: 20px;
        text-align: center;
        padding-top: 5px;
        padding-bottom: 5px;
    }

    div#du_body_psbt #du_submit {
        margin-top: 5px;
    }

    div#du_body_psbt #du_source {
        font-size: 0.7em;
        display: inline;
        font-family: "PT Sans", serif;
    }

    div#du_body_psbt button {
        cursor:pointer;
        background-color: rgb(173,216,230);
        border: 1px solid black;
        color: black;
        padding: 5px 12px;
        text-align: center;
        text-decoration: none;
        margin-bottom: 10px;
        font-size: 20px; 
    }

    div#du_body_psbt #du_search {
        text-align: center;
        padding-top: 10px;
        border: 1.5px solid black;
        background-color: rgba(70, 130, 180, 0.5);
        margin:0 auto;
    }


    /* D3 STYLES */
    div#du_body_psbt #du_chart{
        width: 100%;
        height: 120px;
    }

    div#du_body_psbt .axis text, 
    div#du_body_psbt .label {
        font: 0.8em sans-serif;
    }

    div#du_body_psbt .axis path,
    div#du_body_psbt .axis line {
        fill: none;
        stroke: #000;
        shape-rendering: crispEdges;
    }

    div#du_body_psbt #du_scale-container svg{
        background: linear-gradient(to right, yellow, red);
        border: 0.3px solid black;
        border-radius: 70px;
    }

    /* END OF D3 CSS */


    /* WEB STANDARDS STUFF */
    div#du_body_psbt ::-webkit-input-placeholder {
        color: #606060;
    }

    div#du_body_psbt :-moz-placeholder { /* Firefox 18- */
        color: #606060;
    }

    div#du_body_psbt ::-moz-placeholder {  /* Firefox 19+ */
        color: #606060;
    }

    div#du_body_psbt :-ms-input-placeholder {  
        color: #606060;
    }
    div#du_body_psbt :focus::-webkit-input-placeholder{color:transparent;}
    
    /* MOBILE */
    div#du_body_psbt.du_mobile{
        border: 0 none;        
    }
    div#du_body_psbt.du_mobile #du_chart-container{
        width: 100%;
    }
    div#du_body_psbt.du_mobile .ui-widget.ui-autocomplete{
        font-size: 17px;
    }

</style> 

<!-- END OF CSS, START OF HTML -->

<div id="du_body_psbt" class="du_proj_bikes_thefts du_mobile">
    <div id="du_wait_psbt" class="du_hide"><span>&nbsp;</span></div>
    <noscript><div id="du_js_warning" >This widget requires javascript to work.</div></noscript>
    <a name="du_top"></a>
    <div id="du_header">
        <img class="du_header_img" alt="BIKES THEFTS WHERE YOU LIVE" src="http://trinitymirrordataunit.com.s3.amazonaws.com/img/headers/du_psbt_header.jpg" />
    </div>
    <!-- Everything above here will be mostly the same - below it is my bit -->
    <div id="du_widget">
        <p>How common is bike theft where you live?<br>Start typing the name of your local authority and hit the submit button</p>
        <div id='du_search'>
            <input id="du_auto" size="25"><br>
            <button id="du_submit">SUBMIT</button>
            <p id="du_source">Source: Home Office</p>
        </div>
        <div id="du_widget_res">
            <div id="du_scale-container">
                <h3 id="du_scale-header"></h3>
                <div id="du_scale"></div>
            </div>
            <div id='du_response'>
                <p id="du_response-text"></p>
            </div>
            <div id ="du_chart-container">
                <h3 id="du_chart-header"></h3>
                <div id='du_chart'></div>
            </div>
        </div>
    </div>
</div> 

<!-- End of HTML, start of JS -->

<script>
    // Displays the spinning wheel icon as soon as page loads by removing the du_hide class
    document.getElementById("du_wait_psbt").className = "";
    
    // Sets up widget as a constructor object
    var bikes_thefts_psbt_widget = function () {
        // This bit is the initialising function
        var main = this;
        var jq, mainEl;
        var started = false;
        this.originalJq = false;
        var docUrl = document.URL;
        var clk = 0;
        /* widget related globals - end of init */
        completers = [];
        data = [];

        // Checks if the user is viewing on an iPhone. If it is it changes the autocomplete settings
        var isiPhone = false;
        if ((navigator.userAgent.match(/iPhone/i)) || (navigator.userAgent.match(/iPod/i))) {
            isiPhone = true;
        }

        /* widget related - END */

        // This function starts up the actual widget and triggers when the page has loaded
        var onReady = function () {
            mainEl = jq("#du_body_psbt.du_proj_bikes_thefts");

            // On resize it waits before triggering the resizeEnd function so as not to hammer the DOM  
            jq(window).resize(function () {
                if (main.resizeTO) {
                    clearTimeout(main.resizeTO);
                }
                main.resizeTO = setTimeout(function () {
                    jq(this).trigger("resizeEnd");
                }, 150);
            });

            // Binds the resizeEnd function to the window
            jq(window).bind("resizeEnd", function () {
                main.du_checkParentSize();
            });

            // Checks screen size to determine css
            main.du_checkParentSize();
            
            /* onReady for widget - INI - runs the D3 */
            runWidgetBinds();
            /* onReady for widget - END */

            /* inicio  */

            //getjson(headerData, du_functionOk, du_functionKo);

            /* if cookies used
             if (du_readCookie("du_rpl_r_" + mainID) == "1") {
             } else {
             }*/

            /*
             * 
             du_analytics();
                             
             du_analyticsClick(runnerData.n);
             */


            ///   wait(0);

            // Displays widget
            jq("#du_widget", mainEl).show();
            
            // Hides spinner
            wait(0);
        };

        /* WIDGET FUNCTIONS - ALL THE D3 STUFF */
        var runWidgetBinds = function () {
            jq.getJSON("http://patrickescott.github.io/bikes/bikes_data.json", function (zdata) {
                // Declare empty array for autocomlete options
                data = zdata;
                jq.each(data, function (i, area) {
                    completers.push(i);
                });

                // Set-up auto-complete
                jq('#du_auto', mainEl).autocomplete({
                    messages: {
                        noResults: '',
                        results: function () {
                        }
                    },
                    appendTo: "#du_body_psbt #du_search",
                    source: completers,
                    minLength: 2,
                    change: function (event, ui) {
                        if (ui.item != null && ui.item.value != "") {
                            searchAndShow(ui.item.value);
                        } else {
                            jq(this).val("");
                        }
                    },
                    select: function (event, ui) {
                        /*event.preventDefault();*/
                        var el = jq(this);
                        setTimeout(function () {
                            el.blur();
                        }, 100);
                    },
                    focus: function (event, ui) {
                        event.preventDefault();
                        jq(this)
                                .val(ui.item.value);
                    },
                    open: function (event, ui) {
                        if (isiPhone) {
                            jq('.ui-autocomplete').off('menufocus hover mouseover mouseenter');
                        }
                    },
                    response: function (event, ui) {
                        if (!ui.content.length) {
                            var noResult = {value: "", label: "No matching results"};
                            ui.content.push(noResult);
                        }
                    }
                });

                // Define click event to draw in data
                jq('#du_widget', mainEl).on('click', 'button', function (event) {
                    event.preventDefault();
                    searchAndShow();
                });
            });
        };
        var searchAndShow = function () {
            var place = jq('#du_auto', mainEl).val();
            try {
                jq("#du_widget_res", mainEl).hide().slideDown('slow');
                jq('#du_response-text')
                        .html("In " + place + " there were " + numberWithCommas(data[place].Sept15) + " bike thefts in the year to September 2015 at a rate of  " +
                                numberWithCommas(data[place].rate) + " for every 10,000 residents. The average local authority had 9.6 thefts per 10,000 people.");

                jq(mainEl).find('svg').remove();
                drawChart(data[place], place);

                //jq("#du_scale-container").hide().show('slow');
                //jq("#du_response").hide().show('slow');
                //jq("#du_chart-container").hide().show('slow');
            } catch (error) {
                jq('#du_response-text')
                        .html("Enter a valid local authority from the menu.");
                jq("#du_response").hide().show('slow');
                jq("#du_scale-container").hide();
                jq("#du_chart-container").hide();
            }
        };
        function drawChart(place_data, place_name) {

            jq('#du_chart-header').html("Bikes stolen in 12 months to September in " + place_name);
            jq('#du_scale-header').html("How bad is bike theft in " + place_name + " compared to other areas?");
            // Set up global variables
            var margin = 80,
                    chart_div = d3.select("#du_chart"),
                    svg = chart_div.append("svg"),
                    scale_div = d3.select("#du_scale"),
                    scale_svg = scale_div.append("svg");

            var width, height, x, y, xAxis, xMax, xScale, scaleXAxis;

            var data = [
                {name: '2015', thefts: place_data.Sept15},
                {name: '2014', thefts: place_data.Sept14},
                {name: '2013', thefts: place_data.Sept13},
                {name: '2012', thefts: place_data.Sept12}
            ];

            xMax = d3.max(data, function (d) {
                return d.thefts;
            });


            var scaleData = [{name: "steelblue", rank: place_data.rank, radius: 30},
                {name: "black", rank: place_data.rank, radius: 2}];

            get_dimensions();

            // Scale y-axis
            yAxis = d3.svg.axis()
                    .scale(y)
                    .orient("left");

            // Append y-axis
            svg
                    .append('g')
                    .attr('class', 'y_axis axis')
                    .attr('transform', "translate(" + margin + ",0)")
                    .call(yAxis);
            // Append x-axis	          
            svg
                    .append('g')
                    .attr('class', 'x_axis axis')
                    .attr('transform', "translate(0," + height + ")")
                    .call(xAxis);

            // Creates bars
            svg
                    .selectAll("rect")
                    .data(data).enter()
                    .append("rect")
                    .attr("class", "bar")
                    .attr("x", margin)
                    .attr("y", function (d) {
                        return y(d.name);
                    })
                    .attr("width", function (d) {
                        return x(d.thefts) - margin;
                    })
                    .attr("height", y.rangeBand())
                    .attr("fill", "steelblue")
                    .attr('stroke', 'black')
                    .attr('shape-rendering', 'crispEdges');

            // Creates circles
            scale_svg
                    .selectAll("circle")
                    .data(scaleData)
                    .enter()
                    .append('circle');

            // Plots circles
            var circle = d3.selectAll('circle')

            circle
                    .attr('fill', function (d) {
                        return d['name'];
                    })
                    .attr('r', function (d) {
                        return d.radius;
                    })
                    .attr('cx', function (d) {
                        return xScale(155);
                    })
                    .attr('class', 'bubble')
                    .attr('cy', (height / 2))
                    .attr('stroke', 'black');

            circle
                    .transition()
                    .attr('cx', function (d) {
                        return xScale(d['rank']);
                    })
                    .delay(800)
                    .duration(800)
                    .ease("linear");


            scale_svg
                    .append('g')
                    .attr('class', 'x_axis axis')
                    .attr('transform', "translate(0," + (height / 2) + ")")
                    .call(scaleXAxis);

            var men = scale_svg.append("text")
                    .attr("y", height)
                    .attr("x", margin / 4)
                    .text("LOW CRIME");

            var women = scale_svg.append("text")
                    .attr("y", height)
                    .attr("x", (width - margin / 2))
                    .text("HIGH CRIME");

            // Define function to get screen size and calculate scales.
            function get_dimensions() {


                if ((navigator.userAgent.match(/iPhone/i)) || (navigator.userAgent.match(/iPod/i))) {
                    var ori = window.orientation;
                    width = (ori == 90 || ori == -90) ? screen.height : screen.width;
                    width = parseInt(width, 10) - margin - 30;
                }
                else {
                    width = parseInt(jq('#du_chart-container').width(), 10) - margin;
                }

                height = 90;

                svg.attr("width", width + margin)
                        .attr("height", height + 30);

                // calculate scale for x axis
                x = d3.scale.linear()
                        .range([margin, (margin / 2 + width)])
                        .domain([0, xMax]);

                // Determines scale for y axis
                y = d3.scale.ordinal()
                        .rangeRoundBands([height, 0], .1)
                        .domain(data.map(function (d) {
                            return d.name;
                        }));

                // Creates x-axis
                xAxis = d3.svg.axis()
                        .scale(x)
                        .orient("bottom")
                        .ticks(4);


                scale_svg.attr("width", width + margin)
                        .attr("height", height + 30);

                // calculate scale for x axis
                xScale = d3.scale.linear()
                        .range([(margin / 2), (margin / 2 + width)])
                        .domain([310, 1]);

                scaleXAxis = d3.svg.axis()
                        .scale(xScale)
                        .orient("bottom")
                        .ticks(0)
                        .tickFormat(function (d) {
                            return '';
                        });
            }
            ;

            function update() {
                get_dimensions();

                d3.selectAll(".bar")
                        .attr("width", function (d) {
                            return x(d.thefts) - margin;
                        });

                d3.select(".x_axis").remove();
                svg
                        .append('g')
                        .attr('class', 'x_axis axis')
                        .attr('transform', "translate(0," + height + ")")
                        .call(xAxis);


                d3.select(".x_axis").remove();
                scale_svg
                        .append('g')
                        .attr('class', 'x_axis axis')
                        .attr('transform', "translate(0," + (height / 2) + ")")
                        .attr('z-index', 'inherit')
                        .call(scaleXAxis);

                circle
                        .attr('cx', function (d) {
                            return xScale(d['rank']);
                        })
                        .attr('z-index', 4);

                men.attr("x", margin / 4);
                women.attr("x", (width - margin / 4));
            }
            ;

            // Listen for resize and update chart
            d3.select(window).on('resize', update);
        }
        function numberWithCommas(x) {
            return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }
        /* WIDGET FUNCTIONS - END */

        /* checksize - triggers mobile CSS if width of the body is below a certain size.*/
        this.du_checkParentSize = function () {
            var b = jq(mainEl);
            var pai = jq(mainEl).parent();
            if (pai.width() > 618) {
                b.removeClass("du_mobile");
            } else {
                b.addClass("du_mobile");
            }
        };
        /* checksize - END */


        /* JQUERY - INI - This function runs after page load. It loads external files then triggers onReady function */
        var startJq = function () {
            if (started) {
                return true;
            }
            started = true;
            if (typeof $ !== "undefined") {
                main.originalJq = $.noConflict(true);
            }
            loadJS('http://code.jquery.com/jquery-2.2.0.min.js', function () {
                loadJS('http://code.jquery.com/ui/1.11.4/jquery-ui.min.js', function () {
                    loadJS('http://d3js.org/d3.v3.min.js', function () {
                        jq = $.noConflict(true);
                        $ = main.originalJq;
                        jQuery = main.originalJq;
                        onReady();
                    });
                });
            });
        };

        // FUNCTION TO LOAD THE EXTERNAL SCRIPTS - jQuery, D3 and the jQuery UI
        var loadJS = function (src, callback) {
            var s = document.createElement('script');
            s.src = src;
            s.async = "async";
            s.onreadystatechange = s.onload = function () {
                var state = s.readyState;
                if (!callback.done && (!state || /loaded|complete/.test(state))) {
                    callback.done = true;
                    callback();
                }
            };
            document.getElementsByTagName('head')[0].appendChild(s);
        };
        /* JQUERY - END */

        /* WAIT - INI - FUNCTION TO HIDE THE SPINNER*/
        var wait = function (on) {
            if (on) {
                jq('#du_wait_psbt', mainEl).show();
            } else {
                jq('#du_wait_psbt', mainEl).hide();
            }
        };
        /* WAIT - END */

        /* wait to start - INI */
        var du_delay = setTimeout(function () {
            startJq();
        }, 7000);

        /* If there is an existing window.onload event it puts this in another function and triggers it along with startJq. Otherwise it assigns it to startJq */
        var oldonload = window.onload;
        window.onload = (typeof window.onload != 'function') ?
                startJq : function () {
                    oldonload();
                    startJq();
                };
        /* wait to start - END */
    };
    var proj_bikes_thefts_psbt = new bikes_thefts_psbt_widget();
</script> 
<link rel="stylesheet" href="http://code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css">
<link href='http://trinitymirrordataunit.com.s3.amazonaws.com/js/tmdu_base.css' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=PT+Sans:400,700,400italic|PT+Sans+Narrow:400,700' rel='stylesheet' type='text/css'> 
